-- source include/have_tokudb.inc
--source include/have_debug.inc

--disable_warnings
drop table if exists foo;
--enable_warnings

set session tokudb_disable_hot_alter=ON;

create table foo (a int)engine=TokuDB;

insert into foo values (1);

alter table foo add index first(a);
show create table foo;

SET SESSION debug="d,add_index_fail";
--error 1030
alter table foo add index second(a);
show create table foo;
SET SESSION debug="";




SET SESSION debug="d,prepare_drop_index_fail";
--error 1030
alter table foo add index second(a), drop index first;
show create table foo;
SET SESSION debug="";

SET SESSION debug="d,final_drop_index_fail";
--error 1030
alter table foo add index second(a), drop index first;
show create table foo;
SET SESSION debug="";

SET SESSION debug="d,add_index_fail";
--error 1030
alter table foo add index second(a), drop index first;
show create table foo;
SET SESSION debug="";

SET SESSION debug="d,final_add_index_fail";
--error 1030
alter table foo add index second(a), drop index first;
show create table foo;
SET SESSION debug="";





SET SESSION debug="d,prepare_drop_index_fail";
--error 1030
alter table foo drop index first;
show create table foo;
SET SESSION debug="";

SET SESSION debug="d,final_drop_index_fail";
--error 1030
alter table foo drop index first;
show create table foo;
SET SESSION debug="";


SET SESSION debug="d,final_add_index_fail";
# because error comes after the commit, key should exist
--error 1030
alter table foo add index second(a);
show create table foo;

SET SESSION debug="";
# just to verify that key of second is being used
explain select a from foo FORCE INDEX (second);
select a from foo FORCE INDEX (second);
# just to verify that key of first is being used
explain select a from foo FORCE INDEX (first);
select a from foo FORCE INDEX (first);

drop table foo;